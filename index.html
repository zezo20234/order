<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Food Order - Customer</title>

  <!-- PWA / iOS metadata -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0ea5a4">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Food Orders">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Replace with your icon(s) -->
  <link rel="apple-touch-icon" href="pizza.jpeg">

  <style>
    :root{
      --accent:#0ea5a4; --accent-2:#7c3aed; --muted:#6b7280; --card:#ffffff;
      --glass: rgba(0,0,0,0.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: #ffffff; color:#111827; -webkit-font-smoothing:antialiased;
    }
    .wrap{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    h1{font-size:1.25rem;margin:0}
    .small{font-size:0.9rem;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    .card{
      background:var(--card); border-radius:10px;padding:14px;border:1px solid rgba(15,23,42,0.04);
      box-shadow:0 6px 18px rgba(11,15,26,0.02);
      transition: transform .14s ease, box-shadow .14s ease;
    }
    .card:hover{ transform: translateY(-4px); box-shadow:0 18px 40px rgba(11,15,26,0.06); }
    .menu-item{display:flex;flex-direction:column;gap:10px;border-radius:10px;padding:10px;border:1px solid rgba(15,23,42,0.03)}
    .item-name{font-weight:700}
    .price{font-weight:700;color:var(--accent)}
    .select-row{display:flex;justify-content:space-between;align-items:center}
    input.itm{width:18px;height:18px}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:0;color:white;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:var(--accent);font-weight:700}
    .order-summary{
      position:fixed; left:50%; transform:translateX(-50%); bottom:18px; width:92%; max-width:980px;
      display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;
      background:#ffffff; border:1px solid rgba(15,23,42,0.06); box-shadow:0 12px 30px rgba(11,15,26,0.06);
    }
    .order-summary .muted{color:var(--muted)}
    .ticket{
      width:320px;padding:14px;border:2px dashed rgba(15,23,42,0.08);border-radius:10px;background:#fff;color:#111827;
    }
    .ticket h3{margin:0 0 8px 0}
    @media print{
      body *{visibility:hidden}
      #printArea, #printArea *{visibility:visible}
      #printArea{position:fixed;left:0;top:0;width:100%}
      @page{size:portrait;margin:8mm}
    }
    .fade-in{animation:fadeIn .36s ease both}
    @keyframes fadeIn{ from {opacity:0; transform:translateY(6px)} to {opacity:1; transform:none} }
    .orders-list{display:flex;flex-direction:column;gap:10px}
    .order-card{padding:10px;border-radius:10px;background:#fff;border:1px solid rgba(15,23,42,0.03)}
    .right-align{text-align:right}

    /* Install button top-left */
    #btnAddHome{
      position:fixed; left:12px; top:12px; z-index:9999; border-radius:9px; padding:8px 10px; font-weight:700;
      box-shadow:0 6px 20px rgba(2,6,23,0.12); display:flex; gap:8px; align-items:center;
      background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; border:0; cursor:pointer;
    }

    /* tutorial modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:100000; }
    .modal{ width:92%; max-width:520px; background:white; padding:18px; border-radius:12px; box-shadow:0 18px 40px rgba(11,15,26,0.12) }
    .modal h3{ margin:0 0 8px 0 }
    .steps{ margin-top:8px }
    .steps li{ margin-bottom:8px }
    .close-x{ position:absolute; right:18px; top:18px; background:transparent; border:0; font-weight:700; font-size:16px; color:#666; cursor:pointer; }
  </style>
</head>
<body>
  <!-- Add to home / Install button (top-left) -->
  <button id="btnAddHome" title="Add to home screen">➕ Add to Home</button>

  <div class="wrap">
    <header>
      <div>
        <h1>Food Orders</h1>
        <div class="small">Pick items (one of each). See total and place order.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="authInfo" class="small">Not signed in</div>
        <button id="btnAuth" class="btn" style="margin-left:8px">Login / Create</button>
        <button id="btnMyOrders" class="btn ghost" style="display:none">My Orders</button>
        <button id="btnLogout" class="btn ghost" style="display:none">Logout</button>
      </div>
    </header>

    <main>
      <section class="card fade-in">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <strong>Menu</strong>
          <div class="small">Each item can be chosen once — pick multiple if you want.</div>
        </div>

        <div class="grid" id="menuGrid"></div>
      </section>

      <section id="userArea"></section>
    </main>
  </div>

  <div id="printArea" style="display:none;padding:18px"></div>
  <audio id="paySound" src="pay.mp3" preload="auto"></audio>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // FIREBASE CONFIG (user-provided)
    var firebaseConfig = {
      apiKey: "AIzaSyBClhOYxDhLpQKPwurk1V3vsPXJ1Csew6E",
      authDomain: "project-add05.firebaseapp.com",
      databaseURL: "https://project-add05-default-rtdb.firebaseio.com",
      projectId: "project-add05",
      storageBucket: "project-add05.firebasestorage.app",
      messagingSenderId: "321491234235",
      appId: "1:321491234235:web:1f674625d9f129f2ef689e",
      measurementId: "G-87M4WVB5Z8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // webhook setup: replace with your webhook or call your server endpoint.
    // NOTE: direct browser POST to Discord webhook may be blocked by CORS.
    // It's safer to call your own server or Firebase Function which forwards the webhook.
    const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1415693152651841566/pKKWSwqxR90q-XwObpAJMG8-sX8UUttJH259EouYRcYxojibU6KJO1gMHaXd9a4E0H5w';

    // APP STATE
    const MENU = [
      { id:'falafel', name:'falafel', price:20 },
      { id:'mandy', name:'mandy', price:30 },
      { id:'pasta', name:'pasta', price:35 },
      { id:'cake', name:'cake', price:20 },
      { id:'shay', name:'shay', price:15 },
      { id:'mashawe', name:'mashawe', price:40 },
      { id:'burger', name:'Burger', price:25 }
    ];
    let selections = {};
    let currentUser = null;

    // PWA install prompt - saved event for Android
    let deferredPrompt = null;

    // HELPERS
    function $(id){ return document.getElementById(id); }
    function escapeKey(k){ return (k||'').toString().replace(/[.$#[\]]/g,'_'); }
    function formatMoney(n){ return Number(n).toFixed(2).replace(/\.00$/,''); }
    function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    // INIT
    document.addEventListener('DOMContentLoaded', ()=>{
      try{ const s = localStorage.getItem('fo_user'); if(s) currentUser = JSON.parse(s); }catch(e){ localStorage.removeItem('fo_user'); }
      renderMenu(); renderStickySummary(); updateAuthUI();
      $('btnAuth').onclick = authFlow;
      $('btnMyOrders').onclick = showMyOrders;
      $('btnLogout').onclick = ()=>{ localStorage.removeItem('fo_user'); currentUser=null; updateAuthUI(); showMessage('Logged out'); };
      $('btnAddHome').onclick = openInstallTutorial;

      // register service worker
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('/sw.js').then(reg => {
          console.log('SW registered', reg);
        }).catch(err => console.warn('SW reg failed', err));
      }

      // beforeinstallprompt support (Android/Chrome)
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // show "Install" in our tutorial UI when user opens it
        // optionally indicate availability to user (like change button text)
        $('btnAddHome').textContent = '▸ Install App';
      });
    });

    // RENDER MENU
    function renderMenu(){
      const grid = $('menuGrid'); grid.innerHTML = '';
      MENU.forEach(item=>{
        const card = document.createElement('div'); card.className = 'menu-item';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="item-name">${escapeHtml(item.name)}</div>
              <div class="small">Fresh & tasty</div>
            </div>
            <div class="price">${item.price} SAR</div>
          </div>
          <div class="select-row">
            <label class="small"><input class="itm" type="checkbox" data-id="${item.id}" /> Add</label>
            <div class="small">One per item</div>
          </div>
        `;
        grid.appendChild(card);
      });
      document.querySelectorAll('input.itm').forEach(cb=>{
        cb.addEventListener('change', e=>{
          const id = e.target.dataset.id;
          if(e.target.checked) selections[id] = true; else delete selections[id];
          updateStickySummary();
        });
      });
    }

    // STICKY SUMMARY (bottom)
    function renderStickySummary(){
      const ss = document.createElement('div'); ss.className = 'order-summary'; ss.id = 'orderSummary';
      ss.innerHTML = `
        <div><span class="small">Selected:</span> <strong id="selCount">0</strong> &nbsp;&nbsp; <span class="small">Total:</span> <strong id="selTotal">0</strong> SAR</div>
        <div><button id="btnOrderNow" class="btn" disabled>Order</button></div>
      `;
      document.body.appendChild(ss);
      $('btnOrderNow').addEventListener('click', handleOrderClick);
      updateStickySummary();
    }

    function updateStickySummary(){
      const count = Object.keys(selections).length;
      const total = Object.keys(selections).reduce((s,id)=>{
        const it = MENU.find(m=>m.id===id); return s + (it?it.price:0);
      }, 0);
      $('selCount').textContent = count;
      $('selTotal').textContent = formatMoney(total);
      $('btnOrderNow').disabled = (count === 0);
    }

    // Ask day helper (validates input)
    function askDay(){
      const DAYS = ['Sunday','Monday','Tuesday','Wednesday','Thursday'];
      let tries = 0;
      while(tries < 3){
        let raw = prompt('Which day do you want it? (Sunday, Monday, Tuesday, Wednesday or Thursday)');
        if(raw === null) return null;
        raw = raw.trim().toLowerCase();
        if(!raw) { tries++; alert('Please enter a day.'); continue; }
        const match = DAYS.find(d=>{
          const low = d.toLowerCase();
          return low === raw || low.startsWith(raw) || low.startsWith(raw.slice(0,3));
        });
        if(match) return match;
        tries++;
        alert('Invalid day. Please enter Sunday, Monday, Tuesday, Wednesday or Thursday.');
      }
      return null;
    }

    // SIMPLE AUTH (DB-based)
    function updateAuthUI(){
      const ai = $('authInfo');
      if(currentUser){
        ai.textContent = 'Signed in: ' + currentUser.name;
        $('btnAuth').style.display = 'none';
        $('btnMyOrders').style.display = 'inline-block';
        $('btnLogout').style.display = 'inline-block';
      } else {
        ai.textContent = 'Not signed in';
        $('btnAuth').style.display = 'inline-block';
        $('btnMyOrders').style.display = 'none';
        $('btnLogout').style.display = 'none';
      }
    }

    function authFlow(){
      const name = prompt('Username (no dots):'); if(!name) return;
      const pw = prompt('Password (3+ chars):'); if(!pw || pw.length < 3){ alert('Password 3+ chars'); return; }
      const ref = db.ref('users/' + escapeKey(name));
      ref.once('value').then(snap=>{
        if(snap.exists()){
          const val = snap.val();
          if(val.password !== pw){ alert('Wrong password'); return; }
          currentUser = { name: name }; localStorage.setItem('fo_user', JSON.stringify(currentUser));
          updateAuthUI(); showMessage('Signed in as ' + name);
        } else {
          ref.set({ name: name, password: pw }).then(()=>{
            currentUser = { name: name }; localStorage.setItem('fo_user', JSON.stringify(currentUser));
            updateAuthUI(); showMessage('Account created & signed in as ' + name);
          });
        }
      }).catch(err=>{ alert('Auth error: '+err.message); });
    }

    // ORDER FLOW
    function handleOrderClick(){
      if(!currentUser){ alert('Please login or create an account first.'); return; }
      const ids = Object.keys(selections);
      if(ids.length === 0){ alert('Select at least one item'); return; }

      const chosenDay = askDay();
      if(!chosenDay){ alert('Order cancelled (no day selected).'); return; }

      const items = ids.map(id=>{
        const it = MENU.find(m=>m.id===id);
        return { id: it.id, name: it.name, price: it.price, qty: 1 };
      });
      const total = items.reduce((s,it)=> s + (it.price * it.qty), 0);
      if(!confirm(`Confirm order for ${items.length} item(s) on ${chosenDay}. Total: ${formatMoney(total)} SAR?`)) return;

      // play pay.mp3
      const snd = $('paySound'); if(snd){ snd.currentTime = 0; snd.play().catch(()=>{}); }

      // create incremental order number safely via transaction
      const counterRef = db.ref('orderCounter');
      counterRef.transaction(cur => (cur || 0) + 1, (err, committed, snap) => {
        if(err || !committed){ alert('Could not create order number. Try again.'); return; }
        const number = snap.val();
        const orderId = 'order_' + number + '_' + Date.now();
        const orderObj = {
          number: number,
          owner: currentUser.name,
          items: items,
          day: chosenDay,
          status: 'pending',
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        const updates = {};
        updates['/orders/' + orderId] = orderObj;
        updates['/users/' + escapeKey(currentUser.name) + '/orders/' + orderId] = orderObj;
        db.ref().update(updates).then(()=>{
          showMessage('Order placed — #' + number);
          showTicketPreview(orderObj);
          // reset selections
          selections = {};
          document.querySelectorAll('input.itm').forEach(cb=>cb.checked=false);
          updateStickySummary();

          // SEND DISCORD WEBHOOK (attempt client-side)
          try {
            sendDiscordWebhook(orderObj, number, total);
          } catch(e){
            console.warn('Webhook send failed', e);
          }
        }).catch(e=>{ alert('Save error: ' + e.message); });
      });
    }

    // Attempt to send to Discord webhook from browser.
    // NOTE: This may be blocked by CORS on Discord. If that happens, deploy the server-side Firebase function supplied below
    // and replace DISCORD_WEBHOOK with your function endpoint URL.
    function sendDiscordWebhook(orderObj, number, total){
      if(!DISCORD_WEBHOOK || DISCORD_WEBHOOK.includes('REPLACE_WITH')) {
        console.warn('Discord webhook not configured.');
        return;
      }
      const itemsText = (orderObj.items||[]).map(i=>`${i.name} x${i.qty} (${i.price} SAR)`).join('\n');
      const payload = {
        content: `📣 New order placed — #${number}\nBy: ${orderObj.owner}\nFor: ${orderObj.day}\nTotal: ${formatMoney(total)} SAR\n\nItems:\n${itemsText}`
      };
      fetch(DISCORD_WEBHOOK, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(r=>{
        if(!r.ok) console.warn('Webhook returned non-OK', r.status);
      }).catch(err=>{
        console.warn('Webhook send error (likely CORS). Consider using server-side forwarding.', err);
      });
    }

    // TICKET PREVIEW & PRINT (customers)
    function buildTicketHtml(orderObj){
      const total = (orderObj.items||[]).reduce((s,it)=> s + (it.price * it.qty), 0);
      const itemsHtml = (orderObj.items||[]).map(it=>`<li>${escapeHtml(it.name)} x ${it.qty} — ${it.price} SAR</li>`).join('');
      return `
        <div class="ticket">
          <h3>Food Order Ticket</h3>
          <div style="font-weight:700">Order #: ${orderObj.number}</div>
          <div class="small">By: ${escapeHtml(orderObj.owner)}</div>
          <div class="small">For: ${escapeHtml(orderObj.day || '')}</div>
          <div style="height:8px"></div>
          <div><strong>Items</strong></div>
          <ul style="margin:8px 0 0 18px;color:#111827">${itemsHtml}</ul>
          <div style="margin-top:8px"><strong>Total: ${formatMoney(total)} SAR</strong></div>
          <div style="margin-top:10px;display:flex;justify-content:flex-end">
            <button id="printTicketBtn" class="btn">Print Ticket</button>
          </div>
        </div>
      `;
    }

    function showTicketPreview(orderObj){
      const pa = $('printArea'); pa.style.display = 'block'; pa.innerHTML = buildTicketHtml(orderObj);
      setTimeout(()=>{ const btn = $('printTicketBtn'); if(btn) btn.onclick = ()=>{ window.print(); setTimeout(()=>{ pa.style.display='none'; pa.innerHTML=''; },500); }; },50);
      window.scrollTo({ top:0, behavior:'smooth' });
    }

    // MY ORDERS
    function showMyOrders(){
      if(!currentUser){ alert('Please login'); return; }
      const ua = $('userArea'); ua.innerHTML = '';
      const wrapper = document.createElement('section'); wrapper.className = 'card fade-in';
      wrapper.innerHTML = `<h3>My Orders</h3><div id="ordersList" class="orders-list small">Loading...</div>`;
      ua.appendChild(wrapper);
      const listEl = $('ordersList');
      const ref = db.ref('users/' + escapeKey(currentUser.name) + '/orders');
      ref.on('value', snap=>{
        const v = snap.val(); listEl.innerHTML = '';
        if(!v){ listEl.innerHTML = '<div class="small">No orders yet.</div>'; return; }
        const arr = Object.entries(v).sort((a,b)=>(a[1].number||0)-(b[1].number||0));
        arr.forEach(([id, ord])=>{
          const total = (ord.items||[]).reduce((s,it)=> s + (it.price * it.qty), 0);
          const block = document.createElement('div'); block.className = 'order-card';
          block.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong>Order #${ord.number}</strong><div class="small">Status: ${escapeHtml(ord.status)} — For: ${escapeHtml(ord.day || '')}</div></div>
              <div class="right-align">
                <div class="small">Total: ${formatMoney(total)} SAR</div>
                <div style="margin-top:6px"><button class="btn printMe" data-id="${id}">Print Ticket</button></div>
              </div>
            </div>
            <div class="small" style="margin-top:8px">Items:<ul>${(ord.items||[]).map(i=>`<li>${escapeHtml(i.name)} x ${i.qty} — ${i.price} SAR</li>`).join('')}</ul></div>
          `;
          listEl.appendChild(block);
        });

        // wire print buttons
        document.querySelectorAll('button.printMe').forEach(b=>{
          b.onclick = e=>{
            const id = e.target.getAttribute('data-id');
            db.ref('users/' + escapeKey(currentUser.name) + '/orders/' + id).once('value').then(snap=>{
              const ord = snap.val(); if(!ord) return;
              const pa = $('printArea'); pa.style.display='block'; pa.innerHTML = buildTicketHtml(ord);
              setTimeout(()=>{ window.print(); setTimeout(()=>{ pa.style.display='none'; pa.innerHTML=''; },500); },300);
            });
          };
        });
      });
    }

    // small toast
    function showMessage(msg){
      const t = document.createElement('div'); t.style.position='fixed'; t.style.right='18px'; t.style.bottom='110px';
      t.style.background='linear-gradient(90deg,#0ea5a4,#7c3aed)'; t.style.color='white'; t.style.padding='10px 12px';
      t.style.borderRadius='8px'; t.style.boxShadow='0 8px 26px rgba(2,6,23,0.12)'; t.style.zIndex=99999; t.textContent = msg;
      document.body.appendChild(t); setTimeout(()=> t.style.opacity='0', 2200); setTimeout(()=> t.remove(), 2600);
    }

    // Install / Tutorial UI
    function openInstallTutorial(){
      // create modal
      const backdrop = document.createElement('div'); backdrop.className='modal-backdrop'; backdrop.id='installModal';
      backdrop.innerHTML = `
        <div class="modal">
          <button class="close-x" id="closeInstall">✕</button>
          <h3>Add to Home Screen</h3>
          <p class="small">Install this web app to open it quickly from your device home screen.</p>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="doInstall" class="btn">Install / Add</button>
            <button id="showSteps" class="btn ghost">Show steps (iOS)</button>
          </div>
          <div style="margin-top:12px;font-size:0.95rem">
            <div class="small"><strong>Android (Chrome):</strong> If your device supports it, tap "Install" above to use the native prompt. If nothing happens, use the browser menu → Add to home screen.</div>
          </div>
          <div style="margin-top:10px">
            <strong>iOS (Safari):</strong>
            <ol class="steps small" id="iosSteps" style="display:none">
              <li>Tap the Safari Share button (square with arrow).</li>
              <li>Choose "Add to Home Screen".</li>
              <li>Tap "Add" — the app will appear on your home screen.</li>
            </ol>
          </div>
        </div>
      `;
      document.body.appendChild(backdrop);
      document.getElementById('closeInstall').onclick = ()=>backdrop.remove();
      document.getElementById('showSteps').onclick = ()=>{
        const s = document.getElementById('iosSteps'); s.style.display = s.style.display === 'none' ? 'block' : 'none';
      };
      document.getElementById('doInstall').onclick = async ()=>{
        if(deferredPrompt){
          deferredPrompt.prompt();
          const choice = await deferredPrompt.userChoice;
          if(choice && choice.outcome === 'accepted') showMessage('Thanks — app installed!');
          else showMessage('Install dismissed.');
          deferredPrompt = null;
          backdrop.remove();
        } else {
          // fallback: show native message telling user what to do
          alert('If your browser supports it, use the browser menu and select "Add to home screen". On iOS, open Safari → Share → "Add to Home Screen".');
        }
      };
    }
  </script>
  <h2>MADE BY ZEYAD HATEM</h2>
</body>
</html>
